#!/usr/bin/env python3

from pretf import create_file, register_file, remove_files, terraform, tf


@register_file('iam.tf.json')
def resources(params):

    yield tf('provider.aws', {
        'region': params.aws_region,
    })

    group = yield tf('resource.aws_iam_group.admins', {
        'name': 'admins',
    })

    for username in params.users:

        user = yield tf(f'resource.aws_iam_user.{username}', {
            'name': username,
        })

        yield tf(f'resource.aws_iam_user_group_membership.{username}', {
            'user': user.name,
            'groups': [
                group.name,
            ],
        })


created_file = create_file(
    resources,
    aws_region='eu-west-1',
    users=['ray', 'violet'],
)

remove_files('*.tf.json', exclude=created_file)

terraform.execute()
